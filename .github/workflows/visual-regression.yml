name: Visual Regression Test

on:
  push:
    branches:
      - main
  pull_request_target:

jobs:
  capture_images:
    name: Build and capture images
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y mesa-vulkan-drivers libvulkan-dev libgtk-3-dev ffmpeg

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build vsml_cli
        run: cargo build -p vsml_cli --release --locked

      - name: Run vsml-cli for each example and post-process outputs
        shell: bash
        env:
          WGPU_BACKEND: vulkan
        run: |
          set -euo pipefail
          VSML_EXECUTABLE="$(pwd)/target/release/vsml"
          EXAMPLES_DIR="$(pwd)/examples"
          OUT_ROOT="$(pwd)/visual-regression/images"
          mkdir -p "${OUT_ROOT}"

          find "${EXAMPLES_DIR}" -mindepth 1 -maxdepth 1 -type d | while read -r dir; do
            name="$(basename "$dir")"
            echo "Processing example: $name"
            # 相対参照( https://github.com/vsml-org/the_vsml_converter/issues/41 )の仕様が入っていないので、カレントディレクトリの移動が必要 
            pushd "$dir"
            mkdir -p "${OUT_ROOT}/${name}"

            # Pick the first .vsml file in the subdirectory
            vsml_file="$(find "$dir" -maxdepth 1 -type f -name '*.vsml' | head -n 1 || true)"

            out_mp4="/tmp/out.mp4"

            echo "  -> Running vsml_cli on: $vsml_file"
            "$VSML_EXECUTABLE" "$vsml_file" --output "$out_mp4" --overwrite

            ffmpeg -hide_banner -loglevel error -y -i "$out_mp4" -vf fps=1 "${OUT_ROOT}/${name}/%04d.png"
            ffmpeg -i "$out_mp4" -lavfi "showspectrumpic=s=1920x1080:legend=1" -y "${OUT_ROOT}/${name}/spectrogram.png"
            popd
          done

      - name: Upload visual regression images
        uses: actions/upload-artifact@v5
        with:
          name: vr-images
          path: visual-regression/images

  publish_baseline:
    name: Publish visual regression images (main only)
    if: ${{ github.event_name == 'push' && github.ref_name == github.event.repository.default_branch }}
    needs: capture_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download images artifact
        uses: actions/download-artifact@v6
        with:
          name: vr-images
          path: ./visual-regression/images

      - name: Compress images
        shell: bash
        run: |
          OUT_ROOT="$(pwd)/visual-regression/images"
          tar -I 'zstd -19' -cf images.tar.zst -C "${OUT_ROOT}" .

      - name: Upload images to Cloudflare R2
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            r2 object put ${{ secrets.VRT_CF_R2_BUCKET }}/visual-regression/images.tar.zst --file ./images.tar.zst

  pr_checks:
    name: Visual regression checks for pull request
    if: ${{ github.event_name == 'pull_request_target' }}
    needs: capture_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download images artifact
        uses: actions/download-artifact@v6
        with:
          name: vr-images
          path: ./visual-regression/images

      - name: Download images from Cloudflare R2
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            r2 object get ${{ secrets.VRT_CF_R2_BUCKET }}/visual-regression/images.tar.zst --file main-images.tar.zst

      - name: Run visual regression test
        shell: bash
        run: |
          if [ -f main-images.tar.zst ]; then
            mkdir -p visual-regression/expected
            tar -xaf main-images.tar.zst -C visual-regression/expected
          fi

          npx reg-cli ./visual-regression/images ./visual-regression/expected ./visual-regression/diff --report ./visual-regression/index.html --json ./reg.json --ignoreChange

      - name: Deploy visual regression diff to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            pages deploy --project-name ${{ secrets.VRT_CF_PAGES_PROJECT_NAME }} --branch pr-${{ github.event.pull_request.number }} ./visual-regression

      - name: Post visual regression test summary as PR comment
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = './reg.json';
            const reg = JSON.parse(fs.readFileSync(path, 'utf8'));

            const marker = '<!-- visual-regression-diff-marker -->';

            const body = `${marker}
            ## Visual Regression Test Summary

            | Category | Count |
            |----------|--------|
            | Passed   | ${reg.passedItems.length} |
            | Failed   | ${reg.failedItems.length} |
            | Added    | ${reg.newItems.length} |
            | Deleted  | ${reg.deletedItems.length} |
            | Diff     | ${reg.diffItems.length} |

            [Diff Report](https://pr-${{ github.event.pull_request.number }}.${{ secrets.VRT_CF_PAGES_PROJECT_NAME }}.pages.dev/)
            `;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });
            const oldComments = comments.filter(comment => comment.body.includes(marker));
            for (const { node_id: nodeId } of oldComments) {
              const mutation = `
                mutation($subjectId: ID!) {
                  minimizeComment(input: {
                    subjectId: $subjectId,
                    classifier: OUTDATED
                  }) {
                    minimizedComment {
                      isMinimized
                      minimizedReason
                    }
                  }
                }
              `;

              await github.graphql(mutation, { subjectId: nodeId });
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
